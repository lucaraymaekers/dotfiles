#!/bin/sh

# For when script calls itself
if [ -n "$PASSWORD" ]
then
	pass show "$PASSWORD" &&
		exit
	exit 1
fi


if [ "$MENUCMD" = "tofi" ]
then
	menucmd="tofi --matching-algorithm=normal"
else
	menucmd="$MENUCMD"
fi


die ()
{
	echo "$1" >&2
}

notify ()
{
	notify-send -t 1000 "keyadd" "$1"
	die "$1"
}


SSHFOLDER="$HOME/.ssh"

if test -z "${key:=$1}"
then
	key="$(find "$SSHFOLDER" -iname "*.pub" |
		sed "s,$SSHFOLDER/,," | # Clean
		sed 's/\.pub$//' |
	$menucmd)"
else
	shift
fi
die "key: $key"

test ! -f "$SSHFOLDER/$key" && exit 1

HOST=$(hostnamectl hostname | sed 's/forlure/fl/;s/montecristo/mc/')
die "HOST: $HOST"

if [ "$1" = "-d" ]
then
	if ssh-add -d - < "$SSHFOLDER"/"$key".pub
	then
		notify "deleted <b>$key</b>"
	else
		notify "could not delete."
	fi
# check if key is already added
elif ssh-add -l | grep -q "$(ssh-keygen -lf "$SSHFOLDER"/"$key")"
then
	notify "key already added."
else	
	export PASSWORD="keys/$HOST/ssh/$key"
	export SSH_ASKPASS="$0"
	ssh-add - < "$SSHFOLDER"/"$key" &&
		notify "added <b>$key</b>"
fi
