#!/bin/sh
die ()
{
	echo "$1" >&2
}

# For when script calls itself
if [ -n "$PASSWORD" ]
then
	pass show "$PASSWORD" &&
		exit
	exit 1
fi

key="$(find ~/.ssh -iname "*.pub" |
	sed "s,$HOME/.ssh/,," |
	cut -f1 -d. |
	$MENUCMD)"
die "key: $key"

test ! -f "$HOME/.ssh/$key" && exit 1

HOST=$(hostnamectl hostname | sed 's/forlure/fl/;s/montecristo/mc/')

if [ "$1" = "-d" ]
then
	ssh-add -d - < $HOME/.ssh/$key.pub &&
		notify-send "$0" "deleted <b>$key</b>"
elif ! ssh-add -l | grep -q "$(ssh-keygen -lf $HOME/.ssh/$key)"
then
	export PASSWORD="keys/fl/ssh/$key"
	export SSH_ASKPASS="$0"
	ssh-add - < $HOME/.ssh/$key &&
		notify-send "$0" "added <b>$key</b>"
else
	die "key already added."
	notify-send "$0" "key already added."
fi
