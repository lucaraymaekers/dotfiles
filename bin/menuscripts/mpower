#!/bin/sh

if [ "$1" ]
then
 choice="$1"
else
 choice="$(
 cat <<EOF | commander -c -w 1 -y 9
poweroff
suspend
reboot
firmware
hibernate
windows
bwindows
EOF
 )"
fi

>&2 printf 'choice: %s\n' "$choice"

windows()
{
 NextBoot="$(efibootmgr -u | grep 'Windows' | grep '^Boot[0-9]\{4\}' | cut -c 5-8)"
 expect -f - <<EOF
set pw [exec pass show aluc]
spawn doas efibootmgr --bootnext "$NextBoot" -u
expect "password:"
send "\$pw\r"
expect eof
EOF

}

# Same on both
case "$choice" in
 "bwindows")
  windows
  if [ "$(hostname)" = "spring" ]
  then
   doas /usr/sbin/zzz -R
   exit
  elif [ "$(hostname)" = "winter" ]
  then
   choice="hibernate"
  fi
  ;;
 "windows")
  windows
  choice="reboot"
  ;;
 "firmware") rebootfw; exit ;;
esac

# Winter
if [ "$(hostname)" = "winter" ]; then 
 case "$choice" in
  "suspend") systemctl hybrid-sleep ;;
  "") exit 1 ;;
  *) systemctl "$choice" ;;
 esac
# Spring
elif [ "$(hostname)" = "spring" ]; then
	case "$choice" in
		"suspend") doas /usr/sbin/zzz -H ;;
		"hibernate") doas /usr/sbin/zzz -Z ;;
		"poweroff") doas /usr/sbin/poweroff ;;
		"reboot") doas /usr/sbin/reboot ;;
  "windows")
   ;;
		"") exit 1 ;;
		*) ;;
	esac 
fi
