#!/bin/sh

clocks="${XDG_DATA_HOME:-$HOME}"/clocks.csv

if [ ! -f "$clocks" ]
then
	printf 'start,end,message\n' > "$clocks"
fi

# print clocks file prettily 
if [ "$1" = "-p" ]
then
	# empty
	[ "$(wc -l < "$clocks")" -eq 1 ] && exit

	timefmt="%y%m%d-%T"
	IFS=","
	# skip csv header
	tail -n +2 "$clocks" |   
	while read -r start end message
	do
		printf "%s - %s | %s\n" "$(date -d "@$start" +"$timefmt" )" "$(date -d "@$end" +"$timefmt")" "$message"
	done
	exit
fi

# edit clocks file in $EDITOR
if [ "$1" = "-e" ]
then
	$EDITOR "$clocks"
	exit
fi

trap 'exit 0' INT # The proper way to exit

while true
do
	>&2 printf ' > ' 
	message="$(head -n 1)" 

	[ "$message" ] || exit 1
	printf '\033[1A' # move cursor up once: https://en.wikipedia.org/wiki/ANSI_escape_code

	start_time="$(date +%s)"
	start_time_pretty="$(date -d "@$start_time" +%R)" 
	>&2 printf -- '\r%s- > %s' "$start_time_pretty" "$message"

	# Wait for EOF
	cat > /dev/null 2>&1

	end_time="$(date +%s)"
	end_time_pretty="$(date -d "@$end_time" +%R)" 
	>&2 printf -- '\r%s-%s > %s\n' "$start_time_pretty" "$end_time_pretty" "$message"

	if printf '%s' "$message" | grep ',' > /dev/null
	then
		# escape potential double quotes
		message="$(printf '%s' "$message" | sed -e 's/"/""/g')"
		message="\"$message\""
	fi

	# save clocked time and message
	printf '%s,%s,%s\n' "$start_time" "$end_time" "$message" >> "$clocks"
done
