#!/bin/sh

die() { printf "%s\n" "$@"; exit 1; }

[ "$(id -u)" -ne 0 ] && die "Please run as root."

. /etc/os-release
case "$ID" in 
	"arch") pacman -Sy --noconfirm python-libcharon strongswan ;;
	"debian") apt install strongswan libcharon-extra-plugins libcharon-extauth-plugins ;;
	*) die "Distro is '%s'.\n" "$ID" ;;
esac

read_line() { >&2 printf "%s" "$@"; head -n 1; }

email="$(read_line "email: ")"
password="$(read_line "password: ")"

>&2 printf "%s\n" "/etc/ipsec.conf"

cat <<EOF | tee -a /etc/ipsec.conf
conn EHB-VPN
        keyexchange=ikev2
        dpdaction=clear
        auto=add
        dpdaction=hold
        closeaction=hold
        dpddelay=300s
        eap_identity=$email
        leftauth=eap-mschapv2
        left=%defaultroute
        leftsourceip=%config
        right=vpn.student.ehb.be
        rightauth=pubkey
        rightsubnet=0.0.0.0/0
        rightid= %any
        type=tunnel
EOF

>&2 printf "%s\n" "/etc/ipsec.secrets"

printf "%s : EAP \"%s\"\n" "$email" "$password" |
	tee -a /etc/ipsec.secrets
