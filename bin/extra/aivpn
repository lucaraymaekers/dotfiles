#!/bin/sh

err() { printf "%s\n" "$@"; }

if [ "$1" = "-k" ]
then
	pgrep -f -- "ssh.*-L.*vm" | xargs kill
	exit
fi

err "I: Waiting for connectivity..."
while ! ssh -o ConnectTimeout=1 -o BatchMode=yes vm 2>&1 | grep "Permission denied" > /dev/null
do sleep 1
done


export SSH_ASKPASS="sshpass"
export SSH_ASKPASS_REQUIRE="prefer"
export PASSWORD="zot/qemu"

err "I: Activating vpn"
ssh vm "rasdial \"vpn.student.ehb.be\""

keyadd ehb/ai
ssh -f -N \
	-L 2222:10.2.160.41:22 \
	vm

keyadd ehb/vm_int
ssh -f -N \
	-L 2223:10.2.160.9:22 \
	vm
ssh -f -N \
	-L 2224:10.2.160.10:22 \
	vm
ssh -f -N \
	-L 2225:10.2.160.11:22 \
	vm
